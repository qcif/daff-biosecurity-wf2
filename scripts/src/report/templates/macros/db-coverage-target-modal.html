{% from "macros/alert-level-icon.html" import render_level_icon %}
{% from "macros/error-message.html" import render_error_message %}

{% macro render_target_modal(context) %}

{% set flag_5_1 = context.flags['5.1'][context.target_type][context.target_taxon] %}
{% set flag_5_2 = context.flags['5.2'][context.target_type][context.target_taxon] %}
{% set flag_5_3 = context.flags['5.3'][context.target_type][context.target_taxon] %}
{% set all_flags = [flag_5_1, flag_5_2, flag_5_3] %}
{% set flag = all_flags | max(attribute='level') %}
{% set errors = context.error_log.filter(location_min=5.0, location_max=5.99) %}

<div class="modal fade" id="{{ context.target_id }}Modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Database coverage of {{ context.target_type_text }} <em>{{ context.target_taxon }}</em>
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <div class="modal-body text-start">
        <p>
          This {{ context.target_type_text }} has been independently evaluated against the reference database to determine whether sufficient reference data exists to support identification of this taxon. Insufficient coverage can result in that taxon not be correctly identified as the taxonomic identity of the sample (type-II error).
        </p>

        <p>
          For example, if your sample is from <em>Homo sapiens</em>, but there are no <em>Homo sapiens</em> DNA records in the reference database, the analysis will be unable to detect <em>Homo sapiens</em> as the correct taxonomic identity. In the latter case, the analysis will most likely try to assign the closest relative with existing reference data as the taxonomic identity.
        </p>

        <div class="border p-5">
          <table style="margin: 0 auto 2rem auto;">
            <tbody>
              <tr
                onclick="document.getElementById('dbCovTarget-{{ context.target_id }}').scrollIntoView({ behavior: 'smooth' });"
                style="cursor: pointer;"
              >
                <td class="btn btn-{{ flag_5_1.bs_class }} text-center mb-2">
                  {{ render_level_icon(flag_5_1.level) }}
                </td>
                <td class="px-3">
                  Coverage of <em>{{ context.target_taxon }}</em>
                </td>
              </tr>
              <tr
                onclick="document.getElementById('dbCovRelated-{{ context.target_id }}').scrollIntoView({ behavior: 'smooth' });"
                style="cursor: pointer;"
              >
                <td class="btn btn-{{ flag_5_2.bs_class }} text-center mb-2">
                  {{ render_level_icon(flag_5_2.level) }}
                </td>
                <td class="px-3">
                  Coverage of species in genus <em>{{ context.target_taxon.split(' ')[0] }}</em>
                </td>
              </tr>
              <tr
                onclick="document.getElementById('dbCovCountry-{{ context.target_id }}').scrollIntoView({ behavior: 'smooth' });"
                style="cursor: pointer;"
              >
                <td class="btn btn-{{ flag_5_3.bs_class }} text-center mb-2">
                  {{ render_level_icon(flag_5_3.level) }}
                </td>
                <td class="px-3">
                  Coverage of species in genus <em>{{ context.target_taxon.split(' ')[0] }}</em>
                  in country of origin <strong>{{ context.metadata.country }}</strong>
                </td>
              </tr>
            </tbody>
          </table>

          <hr>

          <div class="my-5" id="dbCovTarget-{{ context.target_id }}">
            <h3>Database coverage of <em>{{ context.target_taxon }}</em></h3>

            <p class="alert alert-{{ flag_5_1.bs_class }}">
              <strong>Flag {{ flag_5_1.flag_id }}{{ flag_5_1.value }}:</strong>
              {{ flag_5_1.outcome }}
              <br>
              <strong>Reasoning:</strong> {{ flag_5_1.explanation }}
            </p>

            <div class="row my-5">
              <div class="col">

                {% set p5_01_errors = errors.filter(location=5.01, context={'target': target_taxon }) %}
                {% if p5_01_errors %}
                {{ render_error_message(p5_01_errors) }}
                {% endif %}

                {% if context.data.target is not none %}
                <div class="big-number alert-{{ flag_5_1.bs_class }}">
                  {{ context.data.target }} records
                </div>
                <p class="my-3">
                  There are {{ context.data.target }} sequences in the reference database for
                  <em>{{ context.target_taxon }}</em>
                  at the given locus <strong>{{ context.metadata.locus }}</strong>.
                </p>

                <!-- If toi and toi not detected, and data.target, show warning message -->
                {% if context.target_type == 'toi' and context.tois_detected['target_taxon'] and context.data.target %}
                <p class="alert alert-warning">
                  <strong>Warning:</strong>
                  The reference database includes records for <em>{{ context.target_taxon }}</em>, but they were not present in the top {{ context.config.BLAST_MAX_TARGET_SEQS }} hits with a sufficient match score to meet candidate criteria. If there are over {{ context.config.BLAST_MAX_TARGET_SEQS }} related species' records in the database (as reported below), it is possible (though rare) that a viable hit for this TOI was present in hits ranked lower than the top {{ context.config.BLAST_MAX_TARGET_SEQS }}.
                </p>
                {% endif %}

                {% endif %}
              </div>

              {% if context.data.map_src_base64 %}
              <div class="col" style="position: relative;">
                <div
                  class="occurrence-map"
                  onclick="this.classList.toggle('expanded')"
                  title="Click to expand/close"
                  data-bs-toggle="tooltip"
                  data-bs-placement="bottom"
                >
                  <img
                    src="{{ context.data.map_src_base64 }}"
                    alt="Map of database coverage"
                    class="img-fluid"
                  >
                  <p style="color: white; text-align: center;">
                    Global occurrence records for <em>{{ context.target_taxon }}</em>.
                    <br>
                    <small class="hide-small">
                      Note that the occurrence data are not exhaustive, and it is possible for this species to occur in regions not shown on the map.
                    </small>
                  </p>
                </div>
              </div>
              {% endif%}
            </div>
          </div>

          {% if flag.value not in [None, 'NA'] %}

          <hr>

          <div class="my-5" id="dbCovRelated-{{ context.target_id }}">
            <h3>Database coverage of species in genus <em>{{ context.target_taxon.split(' ')[0] }}</em></h3>

            <p class="alert alert-{{ flag_5_2.bs_class }}">
              <strong>Flag {{ flag_5_2.flag_id }}{{ flag_5_2.value }}:</strong>
              {{ flag_5_2.outcome }}
              <br>
              <strong>Reasoning:</strong> {{ flag_5_2.explanation }}
            </p>

            <div class="my-5">
              <p>
                <span class="small-number alert-{{ flag_5_2.bs_class }}">
                  <span class="relatedHasReference-{{ context.target_id }}"></span>/<span class="relatedCount-{{ context.target_id }}"></span>
                  (<span class="relatedCoveragePercent-{{ context.target_id }}"></span>%)
                </span>
                 of sequence records were found in the reference database for:
              </p>

               <ul>
                <li>
                  Species in the genus <em>{{ context.target_taxon.split(' ')[0] }}</em>
                </li>
                <li>
                  At the target locus <strong>{{ context.metadata.locus }}</strong>
                </li>
               </ul>
            </div>

            <div class="accordion" id="accordionRelated-{{ context.target_id }}">
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseAccordionRelated-{{ context.target_id }}"
                    aria-expanded="false"
                    aria-controls="collapseAccordionRelated-{{ context.target_id }}"
                  >
                    Per-species reference sequence counts
                  </button>
                </h2>

                <div
                  id="collapseAccordionRelated-{{ context.target_id }}"
                  class="accordion-collapse collapse"
                  data-bs-parent="#accordionRelated-{{ context.target_id }}"
                >
                  <div class="accordion-body">
                    <p class="mb-0 text-center">
                      Number of GenBank records at locus <strong>{{ context.metadata.locus }}</strong>
                    </p>

                    <div class="verticalScrollChart" id="dbcov-plot-related-{{ context.target_id }}"></div>

                    <script>
                      document.addEventListener('DOMContentLoaded', function() {
                        var data = DB_COVERAGE['{{ context.target_type }}']['{{ context.target_taxon }}'].related;
                        var entries = Object.entries(data);
                        entries.sort((a, b) => a[1] - b[1]);
                        var keys = entries.map(entry => entry[0]);
                        var values = entries.map(entry => entry[1]);
                        var keyLength = Math.max(...keys.map(key => key.length));
                        var plotData = [{
                          type: 'bar',
                          x: values,
                          y: keys,
                          orientation: 'h'
                        }];
                        var height = Math.max(300, 25 * keys.length);
                        Plotly.newPlot(
                          'dbcov-plot-related-{{ context.target_id }}',
                          plotData,
                          {
                            margin: { t: 20, r: 0, b: 0, l: keyLength * 8 },
                            height: height,
                            xaxis: {
                              side: 'top',
                            },
                          }
                        );

                        zeroValues = values.filter(value => value === 0).length;
                        coverage = values.length - zeroValues;
                        coverage_percent = Math.round(coverage / values.length * 100);
                        $(".relatedHasReference-{{ context.target_id }}").text(coverage);
                        $(".relatedCount-{{ context.target_id }}").text(values.length);
                        $(".relatedCoveragePercent-{{ context.target_id }}").text(coverage_percent);
                      });
                    </script>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <hr>

          <div class="my-5" id="dbCovCountry-{{ context.target_id }}">
            <h3>
              Database coverage of species in genus <em>{{ context.target_taxon.split(' ')[0] }}</em>
              that occur in country of origin <strong>{{ context.metadata.country }}</strong>
            </h3>

            {% if context.metadata.country %}

            <p class="alert alert-{{ flag_5_3.bs_class }}">
              <strong>Flag {{ flag_5_3.flag_id }}{{ flag_5_3.value }}:</strong>
              {{ flag_5_3.outcome }}
              <br>
              <strong>Reasoning:</strong> {{ flag_5_3.explanation }}
            </p>

            <div class="my-5">
              <p>
                <span class="small-number alert-{{ flag_5_3.bs_class }}">
                  <span class="relatedCountryHasReference-{{ context.target_id }}"></span>/<span class="relatedCountryCount-{{ context.target_id }}"></span>
                  (<span class="relatedCountryCoveragePercent-{{ context.target_id }}"></span>%)
                </span>
                 of sequence records were found in the reference database for:
              </p>

               <ul>
                <li>
                  Species in the genus <em>{{ context.target_taxon.split(' ')[0] }}</em>
                </li>
                <li>
                  At the target locus <strong>{{ context.metadata.locus }}</strong>
                </li>
                <li>
                  In the sample country of origin <strong>{{ context.metadata.country }}</strong>
                </li>
               </ul>
            </div>

            <div class="accordion" id="accordionRelatedCountry-{{ context.target_id }}">
              <div class="accordion-item">
                <h2 class="accordion-header">
                  <button
                    class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapseAccordionRelatedCountry-{{ context.target_id }}"
                    aria-expanded="false"
                    aria-controls="collapseAccordionRelatedCountry-{{ context.target_id }}"
                  >
                    Per-species reference sequence counts
                  </button>
                </h2>

                <div
                  id="collapseAccordionRelatedCountry-{{ context.target_id }}"
                  class="accordion-collapse collapse"
                  data-bs-parent="#accordionRelatedCountry-{{ context.target_id }}"
                >
                  <div class="accordion-body">
                    <p class="mb-0 text-center">
                      Number of GenBank records at locus
                      <strong>{{ context.metadata.locus }}</strong>
                    </p>

                    <div class="verticalScrollChart" id="dbcov-plot-relatedCountry-{{ context.target_id }}"></div>

                    <script>
                      document.addEventListener('DOMContentLoaded', function() {
                        var data = DB_COVERAGE['{{ context.target_type }}']['{{ context.target_taxon }}'].country;
                        var entries = Object.entries(data);
                        entries.sort((a, b) => a[1] - b[1]);
                        var keys = entries.map(entry => entry[0]);
                        var values = entries.map(entry => entry[1]);
                        var keyLength = Math.max(...keys.map(key => key.length));
                        var plotData = [{
                          type: 'bar',
                          x: values,
                          y: keys,
                          orientation: 'h'
                        }];
                        var height = Math.max(300, 25 * keys.length);
                        Plotly.newPlot(
                          'dbcov-plot-relatedCountry-{{ context.target_id }}',
                          plotData,
                          {
                            margin: { t: 20, r: 0, b: 0, l: keyLength * 8 },
                            height: height,
                            xaxis: {
                              side: 'top',
                            },
                          }
                        );

                        zeroValues = values.filter(value => value === 0).length;
                        coverage = values.length - zeroValues;
                        coverage_percent = Math.round(coverage / values.length * 100);
                        $(".relatedCountryHasReference-{{ context.target_id }}").text(coverage);
                        $(".relatedCountryCount-{{ context.target_id }}").text(values.length);
                        $(".relatedCountryCoveragePercent-{{ context.target_id }}").text(coverage_percent);
                      });
                    </script>
                  </div>
                </div>
              </div>
            </div>

            {% else %}
            <p class="alert alert-info">
              A country of origin was not provided in the sample metadata, so this analysis could not be performed.
            </p>
            {% endif %}

          </div>
          {% endif %}

        </div>
      </div>
    </div>
  </div>
</div>

{% endmacro %}
