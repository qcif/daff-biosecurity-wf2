{% from "macros/alert-level-icon.html" import render_level_icon %}
{% from "macros/db-coverage-target-modal.html" import render_target_modal %}

<h3>Result overview</h3>

<div class="my-3">
  <div class="alert alert-{{ conclusions.flags['1'].bs_class }}">
    <p class="box-{{ conclusions.flags['1'].bs_class }} text-center font-xxl mb-3">
      <span class="px-3">
        {{ render_level_icon(conclusions.flags['1'].level) }}
      </span>
      {% if conclusions.summary.result.confirmed %}
      <em>
        {{ conclusions.summary.result.species }}
      </em>
      {% else %}
      <strong>Inconclusive</strong>
      {% endif %}
    </p>
    <p class="font-large mb-1">
      <strong>Outcome</strong>: {{ conclusions.flags['1'].outcome }}.
    </p>
    <p class="font-large mb-1">
      <strong>Reasoning: [Flag 1{{ conclusions.flags['1'].value }}]</strong>
      {{ conclusions.flags['1'].explanation }}.
    </p>
  </div>
</div>

<table class="table border alert-{{ conclusions.summary.pmi['bs-class'] }}">
  <tr>
    <td>Preliminary morphology ID confirmed?</td>
    <td style="width: 75px;">
      {% if conclusions.summary.result.confirmed %}
      <strong class="text-{{ conclusions.summary.pmi['bs-class'] }}">
        {{ conclusions.summary.pmi.confirmed }}
      </strong>
      {% else %}
      <strong>NA</strong>
      {% endif %}
    </td>
  </tr>
  <tr>
    <td>
      <small>
        <p class="alert mb-1 p-2">
          {{ conclusions.summary.pmi.explanation | safe }}
          <em>{{ metadata.preliminary_id }}</em>.
        </p>
      </small>
    </td>
    <td style="width: 75px;">
      {% set flags = conclusions.flags %}
      {% set taxon = metadata.preliminary_id %}
      {% set target_id = 'pmi-' + taxon | css_hash %}
      {% set all_flags = [flags['5.1']['pmi'][taxon], flags['5.2']['pmi'][taxon], flags['5.3']['pmi'][taxon]] %}
      {% set flag = all_flags | max(attribute='level') %}

      <button
        class="btn btn-{{ flag.bs_class }}"
        data-bs-toggle="tooltip"
        data-bs-placement="bottom"
        title="{{ flag.outcome }}"
        onclick="new bootstrap.Modal(document.getElementById('{{ target_id }}Modal')).show();"
        type="button"
        style="min-width: 3rem;"
      >
        {{ render_level_icon(flag.level) }}
      </button>


      {{ render_target_modal(db_coverage['pmi'][taxon], target_id, taxon, 'pmi', "Preliminary Morphology ID", flags, metadata, error_log) }}
    </td>
  </tr>
</table>

{% if conclusions.summary.toi %}
<table
  class="table"
  style="background: #eee;"
>
  <tr class="alert-{{ conclusions.summary.toi['bs-class'] }}">
    <td>Taxa of interest detected?</td>
    <td style="width: 75px;">
      <strong class="text-{% if conclusions.summary.toi.detected %}success{% else %}danger{% endif %}">
        {{ 'True' if conclusions.summary.toi.detected else 'False' }}
      </strong>
    </td>
  </tr>
  <tr>
    <td colspan="2">
      <small>
        {% for item in conclusions.summary.toi.criteria %}
        <p class="alert alert-{{ item['bs-class'] }} mb-1 p-2">
          {{ item.message | safe }}
        </p>
        {% endfor %}
      </small>
    </td>
  </tr>
</table>
{% else %}
<p class="alert alert-secondary">No taxa of interest provided at rank genus/species</p>
{% endif %}
