<div class="my-5 phylotree">
  <div id="phylotree"></div>
  <div class="controls">
    <small>
      <p class="mb-1">
        <code>Click + drag</code> to pan
      </p>
      <p class="mb-1">
        <code>Scroll</code> to zoom in/out
      </p>
      <p class="text-center mb-0">
        <button
          class="btn btn-sm btn-outline-secondary"
          title="Full screen"
          onclick="fullScreenTree();"
          id="maximizeTreeBtn"
        >
          Full screen
        </button>
      </p>
      <p class="text-center mb-0">
        <button
          class="btn btn-sm btn-outline-secondary"
          title="Full screen"
          onclick="fullScreenTree(reset=1);"
          id="minimizeTreeBtn"
        >
          Minimize
        </button>
      </p>
    </small>
  </div>

  <p class="my-3 px-5">
    <small>
      The phylogetic tree was constructed with
      <a href="http://www.atgc-montpellier.fr/fastme/" target="_blank">
        FastME
      </a>
      using the Neighbor-Joining method. Multiple-sequence alignment of the candidate reference sequences was performed using
      <a href="https://mafft.cbrc.jp/alignment/server/index.html" target="_blank">MAFFT</a>.

      The visualization is rendered with
      <a href="" target="_blank"></a>.
    </small>
  </p>
</div>

<script src="https://unpkg.com/@phylocanvas/phylocanvas.gl@latest/dist/bundle.min.js"></script>
<script>
  // Hit subject, accession on hover?
  const newickString = "{{ tree_nwk_str }}";
  const colors = [
    "blue", "#00FF00", "#0000FF", "#FFFF00", "#FF00FF", "#00FFFF",
    "#800000", "#008000", "#000080", "#808000", "#800080", "#008080",
    "#C0C0C0", "#808080", "#FFA500", "#A52A2A", "#D2691E", "#8B4513",
    "#5F9EA0", "#4682B4", "#7FFF00", "#D2691E",
  ];
  const speciesColors = {
    {% for hit in candidates.species %}
      "{{ hit.species }}": colors[{{ loop.index0 }}] || "black",
    {% endfor %}
  }
  const leafNames = {
    {% for hit in candidates.hits %}
      "{{ hit.accession }}": {
        label: "{{ hit.species }}",
        fillColour: speciesColors["{{ hit.species }}"] || "black",
      },
    {% endfor %}
  };
  const leafStyles = {
    QUERY: {
      fillColour: "red",
      shape: phylocanvas.Shapes.Star,
      nodeSize: 25,  // This is ignored
    },
    ...leafNames,
  }
  const parent = document.querySelector("#phylotree");
  const defaultTreeSize = {
    width: parent.offsetWidth,
    height: 500,
  };
  const tree = new phylocanvas.PhylocanvasGL(
    parent,
    {
      size: defaultTreeSize,
      nodeSize: 10,
      showLabels: true,
      showLeafLabels: true,
      selectedIds: ["QUERY"],
      interactive: true,
      source: newickString,
      type: phylocanvas.TreeTypes.Rectangular,
      zoom: -0.5,
      styles: leafStyles,
    },
  );

  const fullScreenTree = (reset = 0) => {
    const treeWrapper = $('.phylotree');
    if (reset) {
      treeWrapper.removeClass("fullscreen");
      treeWrapper.addClass("my-5");
      $('#minimizeTreeBtn').hide();
      $('#maximizeTreeBtn').show();
      tree.resize(defaultTreeSize.width, defaultTreeSize.height);
    } else {
      treeWrapper.addClass("fullscreen");
      treeWrapper.removeClass("my-5");
      console.log("treeWrapper:");
      console.log(treeWrapper);
      $('#minimizeTreeBtn').show();
      $('#maximizeTreeBtn').hide();
      tree.resize(
        window.innerWidth,
        window.innerHeight - 50,
      );
    }
  }

  // tree.handleClick(); ??

</script>
